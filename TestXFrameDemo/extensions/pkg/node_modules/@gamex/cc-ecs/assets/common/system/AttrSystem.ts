import { Node, UIOpacity, UITransform } from 'cc';
import { AttrComponent } from '../component/AttrComponent';

export class AttrSystem {
    private static _inst: AttrSystem = null;
    static get inst() {
        if (this._inst) return this._inst;
        this._inst = new AttrSystem();
        return this._inst;
    }

    public innerExecute(attr: AttrComponent, node: Node = null) {
        node = node || attr.entity.node;

        if (attr.active !== node.active) {
            node.active = attr.active;
        }
        if (!attr.active) {
            return;
        }

        if (attr.refreshPosition) {
            node.setPosition(attr.x, attr.y, attr.z);
        }
        if (attr.refreshScale) {
            node.setScale(attr.scaleX, attr.scaleY, attr.scaleZ);
        }
        if (attr.refreshAngle) {
            node.angle = attr.angle;
        }
        if (attr.refreshOpacity) {
            // 没有UIOpacity组件 === (opacity为255)
            let uiOpacity = node.getComponent(UIOpacity);
            if (attr.opacity !== 255) {
                if (!uiOpacity) uiOpacity = node.addComponent(UIOpacity);
                uiOpacity.opacity = attr.opacity;
            } else if (uiOpacity) {
                uiOpacity.opacity = 255;
            }
        }
        if (attr.refreshAnchor || attr.refreshSize) {
            let uiTransform = node.getComponent(UITransform);

            if (attr.refreshAnchor) {
                // 没有UITransform组件 === (node.anchorX=node.anchorY=0.5)
                if (attr.anchorX !== 0.5 || attr.anchorY !== 0.5) {
                    if (!uiTransform) uiTransform = node.addComponent(UITransform);
                    uiTransform.setAnchorPoint(attr.anchorX, attr.anchorY);
                } else if (uiTransform) {
                    uiTransform.setAnchorPoint(attr.anchorX, attr.anchorY);
                }
            }

            if (attr.refreshSize) {
                // 没有UITransform组件 === (node.width=node.height=0)
                if (attr.width !== 0 || attr.height !== 0) {
                    if (!uiTransform) uiTransform = node.addComponent(UITransform);
                    uiTransform.setContentSize(attr.width, attr.height);
                } else if (uiTransform) {
                    uiTransform.setContentSize(attr.width, attr.height);
                }
            }
        }

        AttrComponent.innerHandle(attr);
    }
}